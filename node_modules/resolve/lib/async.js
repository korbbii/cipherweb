var fs = require('fs');
var getHomedir = require('./homedir');
var path = require('path');
var caller = require('./caller');
var nodeModulesPaths = require('./node-modules-paths');
var normalizeOptions = require('./normalize-options');
var isCore = require('is-core-module');

var realpathFS = process.platform !== 'win32' && fs.realpath && typeof fs.realpath.native === 'function' ? fs.realpath.native : fs.realpath;

var homedir = getHomedir();
var defaultPaths = function () {
    return [
        path.join(homedir, '.node_modules'),
        path.join(homedir, '.node_libraries')
    ];
};

var defaultIsFile = function isFile(file, cb) {
    fs.stat(file, function (err, stat) {
        if (!err) {
            return cb(null, stat.isFile() || stat.isFIFO());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultIsDir = function isDirectory(dir, cb) {
    fs.stat(dir, function (err, stat) {
        if (!err) {
            return cb(null, stat.isDirectory());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultRealpath = function realpath(x, cb) {
    realpathFS(x, function (realpathErr, realPath) {
        if (realpathErr && realpathErr.code !== 'ENOENT') cb(realpathErr);
        else cb(null, realpathErr ? x : realPath);
    });
};

var maybeRealpath = function maybeRealpath(realpath, x, opts, cb) {
    if (opts && opts.preserveSymlinks === false) {
        realpath(x, cb);
    } else {
        cb(null, x);
    }
};

var defaultReadPackage = function defaultReadPackage(readFile, pkgfile, cb) {
    readFile(pkgfile, function (readFileErr, body) {
        if (readFileErr) cb(readFileErr);
        else {
            try {
                var pkg = JSON.parse(body);
                cb(null, pkg);
            } catch (jsonErr) {
                cb(null);
            }
        }
    });
};

var getPackageCandidates = function getPackageCandidates(x, start, opts) {
    var dirs = nodeModulesPaths(start, opts, x);
    for (var i = 0; i < dirs.length; i++) {
        dirs[i] = path.join(dirs[i], x);
    }
    return dirs;
};

module.exports = function resolve(x, options, callback) {
    var cb = callback;
    var opts = options;
    if (typeof options === 'function') {
        cb = opts;
        opts = {};
    }
    if (typeof x !== 'string') {
        var err = new TypeError('Path must be a string.');
        return process.nextTick(function () {
            cb(err);
        });
    }

    opts = normalizeOptions(x, opts);

    var isFile = opts.isFile || defaultIsFile;
    var isDirectory = opts.isDirectory || defaultIsDir;
    var readFile = opts.readFile || fs.readFile;
    var realpath = opts.realpath || defaultRealpath;
    var readPackage = opts.readPackage || defaultReadPackage;
    if (opts.readFile && opts.readPackage) {
        var conflictErr = new TypeError('`readFile` and `readPackage` are mutually exclusive.');
        return process.nextTick(function () {
            cb(conflictErr);
        });
    }
    var packageIterator = opts.packageIterator;

    var extensions = opts.extensions || ['.js'];
    var includeCoreModules = opts.includeCoreModules !== false;
    var basedir = opts.basedir || path.dirname(caller());
    var parent = opts.filename || basedir;

    opts.paths = opts.paths || defaultPaths();

    // ensure that `basedir` is an absolute path at this point, resolving against the process' current working directory
    var absoluteStart = path.resolve(basedir);

    maybeRealpath(
        realpath,
        absoluteStart,
        opts,
        function (err, realStart) {
            if (err) cb(err);
            else init(realStart);
        }
    );

    var res;
    function init(basedir) {
        if ((/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/).test(x)) {
            res = path.resolve(basedir, x);
            if (x === '.' || x === '..' || x.slice(-1) === '/') res += '/';
            if ((/\/$/).test(x) && res === basedir) {
                loadAsDirectory(res, opts.package, onfile);
            } else loadAsFile(res, opts.package, onfile);
        } else if (includeCoreModules && isCore(x)) {
            return cb(null, x);
        } else loadNodeModules(x, basedir, function (err, n, pkg) {
            if (err) cb(err);
            else if (n) {
                return maybeRealpath(realpath, n, opts, function (err, realN) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realN, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function onfile(err, m, pkg) {
        if (err) cb(err);
        else if (m) cb(null, m, pkg);
        else loadAsDirectory(res, function (err, d, pkg) {
            if (err) cb(err);
            else if (d) {
                maybeRealpath(realpath, d, opts, function (err, realD) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realD, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function loadAsFile(x, thePackage, callback) {
        var loadAsFilePackage = thePackage;
        var cb = callback;
        if (typeof loadAsFilePackage === 'function') {
            cb = loadAsFilePackage;
            loadAsFilePackage = undefined;
        }

        var exts = [''].concat(extensions);
        load(exts, x, loadAsFilePackage);

        function load(exts, x, loadPackage) {
            if (exts.length === 0) return cb(null, undefined, loadPackage);
            var file = x + exts[0];

            var pkg = loadPackage;
            if (pkg) onpkg(null, pkg);
            else loadpkg(path.dirname(file), onpkg);

            function onpkg(err, pkg_, dir) {
                pkg = pkg_;
                if (err) return cb(err);
                if (dir && pkg && opts.pathFilter) {
                    var rfile = path.relative(dir, file);
                    var rel = rfile.slice(0, rfile.length - exts[0].length);
                    var r = opts.pathFilter(pkg, x, rel);
                    if (r) return load(
                        [''].concat(extensions.slice()),
                        path.resolve(dir, r),
                        pkg
                    );
                }
                isFile(file, onex);
            }
            function onex(err, ex) {
                if (err) return cb(err);
                if (ex) return cb(null, file, pkg);
                load(exts.slice(1), x, pkg);
            }
        }
    }

    function loadpkg(dir, cb) {
        if (dir === '' || dir === '/') return cb(null);
        if (process.platform === 'win32' && (/^\w:[/\\]*$/).test(dir)) {
            return cb(null);
        }
        if ((/[/\\]node_modules[/\\]*$/).test(dir)) return cb(null);

        maybeRealpath(realpath, dir, opts, function (unwrapErr, pkgdir) {
            if (unwrapErr) return loadpkg(path.dirname(dir), cb);
            var pkgfile = path.join(pkgdir, 'package.json');
            isFile(pkgfile, function (err, ex) {
                // on err, ex is false
                if (!ex) return loadpkg(path.dirname(dir), cb);

                readPackage(readFile, pkgfile, function (err, pkgParam) {
                    if (err) cb(err);

                    var pkg = pkgParam;

                    if (pkg && opts.packageFilter) {
                        pkg = opts.packageFilter(pkg, pkgfile);
                    }
                    cb(null, pkg, dir);
                });
            });
        });
    }

    function loadAsDirectory(x, loadAsDirectoryPackage, callback) {
        v   · ê  ÿÿ !ÿçcy&    » Ü    !şcS L 0@=u@J* 4C9"u%J	 ?Í?39/ı}æ?9ı}æ10#"&'7326547.'732>54.'.54>32&&#"	J‰Ây$0B)/VyJ'Q,@GIªH8eTA*L¾jL{W01Og6?mP.E´ovèX+q±Yw†$<Q-A‚h@·g¤wE_)4/P:!	,8ÂÊ%3 <X8.:&6OpJ^›n<3&Ë-(dT-?+.Irÿÿ !şcS&    ß Ÿ  ÿÿ ¯  y&    »  ÿÿ ¯ş:&    ß –    ¯  :  @H  H ?í2?9/3í2103!7!!!!## ëHş\)=*ş\H*şüxôxëZÍÍş¦ÍıºFÿÿ ‚ÿçmx&    ¯@  ÿÿ ‚ÿçmx&    ³Í  ÿÿ ‚ÿçmx&    ·j  ÿÿ ‚ÿçmx&    Àk  ÿÿ ‚ÿçm‰&    Äo  ÿÿ ‚ÿçmQ&    Èg  ÿÿ ‚ÿçm&    ÌX  ÿÿ ‚ÿçmß&    Ğ`  ÿÿ ‚ÿçmx&    Ô¿    ‚şm: : @)0! 	J 	 ?í?9??Í10".54673326766733267#".54>7Cz­j0
Ÿô¤7ZCh›3¢ô¬/<M0BƒhA" :!L$+I40A&Bp’Q0[/üä#@0T?%W`#ZAüÀX‚cK ,UTY/
¢+?((QLF ÿÿ ×  Êx&    ¯I  ÿÿ ×  Êx&    ³Ì  ÿÿ ×  Êx&    ·R  ÿÿ ×  Ê‰&    Äb  ÿÿ Ã  *x&    ¯ Ó  ÿÿ Ã  *x&    ³g  ÿÿ Ã  *x&    · ÷  ÿÿ Ã  *‰&    Ä  ÿÿ    şx&    ³u  ÿÿ    şy&    »  ÿÿ    ş©&    Ø    <şc¨: " @" /Í???99?10#"&'732>7&'##3367¨şÛ.V‡g C)':*
şíe<-|ôíe<3|:úz?y_:	Ã
3Q9QØ©¦×ı«:ı¯×ªƒúU   F  q:  - "@HH,H ?í?í9/]3í2103!2#!#%!!3267>76&'&&##q¢rgš>JlF"*Gm—eOÄ…ş‚x¢ÁL*ş³N—^:LpL'JQ'hKº'Zt‹N1‚•Šv($FÍÍş‡!'v¤TnŒ"  <  t:  $ @#JJ ??99//íí1032#".'#332>54&'&&##[½fxlSŸê˜,(!;ôô±>%^Œ\.2*P<–C"(¢li¯~Fşç:ü«&Da:/@
   Uÿçá $ : "@!%*W4WW ?í?í?í9?10%327#"&'##".54>32373.#"3267667t*)>9RUEŸLAhH&6Oh€KE|.#ÊŒŠ	'//M=,533f('é¾MGUJ0X|LQ¤—„b8:>`ı]!â-Kahe+UPE<(fB   dÿçã¨  6 @6  W,W  ?í?í9?1032>54.#"3>32#".54673Z;:1RC4#3$!KC7c2>J*>oR0;\}¡cNzU-	Ùì{!=I*G]gi/"=/>_DâND' ,W‚VJ–„d:0Rq@7-   Uÿç’á % @ tW"tW ?ı}æ?ı}æ10&&#"3267#".54>32j6k+BgM5!2E(C’I+3–UJŠj@:[~§e9•5ñ+G[`]&9M-%!Ğ#*[gC“a9  Uÿçl¨ % : "@! &+W5WW	 ?í?í?í9?10%327#"&'##".54>3233.#"326767t+)BRUEŸLAhH&5Ne{HHv+wìğ‹	&//M<-537l*,é¾MGUJ0X|LQ¤—„b8;=?û~!Ş-Kahe+UPNDJs  UÿçÆá  1 @W!W-tW! ?ı}æ?í9/í104&#"2>7#"'3267#".54>32Ø45(SI:jX&îOšâ“;T4N¬@+>ŸZkg2 >\y–XM|W0Ø!0 ?[;.;Q[05O2& Ğ:iWM˜‹wW2&Eb  şÏşÇÁ 0 @*W#UW
U ?í?í?í?í10!!#"&'732>7#737667>32&&#"))şı·(?¾s6c("F8N7$«®)­'MW`1<m%&.J3LÉÃüJj'ZI½>^A3ÃyFe'-A*¸$&>'  ÿºşá ) > &@t"W */W9W ?í?í9??ı}æ10%#".54>32373#"&'732>767.#"326767r2„LAhH&5Oh€LE|.#ÊË]‹¿|U«K)=‹GVzU7x	'/0M=,530a';kBB0X|LQ¤—„b8:>`ü-zµw:Ã )R{Q0i-Kahe+UP=6Q  <  ¨ % @%
W 
 ???í99?106654&#"#33>32#8<I~*dì,ì^AN[29eM,	wìN138PD&1!ş¨ş;9[5(!@\<%Z-ıÄ  2  P¨   µ
  ?ÖÍ?1033$4ø4şÊìÊ§şÿûYÉü7 şÔşk¨   ·W  ?ÖÍ?í103#"&'732>73ìè* 0“l1h$(Q>(9(4ø4Éû£Ml';;