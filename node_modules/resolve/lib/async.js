var fs = require('fs');
var getHomedir = require('./homedir');
var path = require('path');
var caller = require('./caller');
var nodeModulesPaths = require('./node-modules-paths');
var normalizeOptions = require('./normalize-options');
var isCore = require('is-core-module');

var realpathFS = process.platform !== 'win32' && fs.realpath && typeof fs.realpath.native === 'function' ? fs.realpath.native : fs.realpath;

var homedir = getHomedir();
var defaultPaths = function () {
    return [
        path.join(homedir, '.node_modules'),
        path.join(homedir, '.node_libraries')
    ];
};

var defaultIsFile = function isFile(file, cb) {
    fs.stat(file, function (err, stat) {
        if (!err) {
            return cb(null, stat.isFile() || stat.isFIFO());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultIsDir = function isDirectory(dir, cb) {
    fs.stat(dir, function (err, stat) {
        if (!err) {
            return cb(null, stat.isDirectory());
        }
        if (err.code === 'ENOENT' || err.code === 'ENOTDIR') return cb(null, false);
        return cb(err);
    });
};

var defaultRealpath = function realpath(x, cb) {
    realpathFS(x, function (realpathErr, realPath) {
        if (realpathErr && realpathErr.code !== 'ENOENT') cb(realpathErr);
        else cb(null, realpathErr ? x : realPath);
    });
};

var maybeRealpath = function maybeRealpath(realpath, x, opts, cb) {
    if (opts && opts.preserveSymlinks === false) {
        realpath(x, cb);
    } else {
        cb(null, x);
    }
};

var defaultReadPackage = function defaultReadPackage(readFile, pkgfile, cb) {
    readFile(pkgfile, function (readFileErr, body) {
        if (readFileErr) cb(readFileErr);
        else {
            try {
                var pkg = JSON.parse(body);
                cb(null, pkg);
            } catch (jsonErr) {
                cb(null);
            }
        }
    });
};

var getPackageCandidates = function getPackageCandidates(x, start, opts) {
    var dirs = nodeModulesPaths(start, opts, x);
    for (var i = 0; i < dirs.length; i++) {
        dirs[i] = path.join(dirs[i], x);
    }
    return dirs;
};

module.exports = function resolve(x, options, callback) {
    var cb = callback;
    var opts = options;
    if (typeof options === 'function') {
        cb = opts;
        opts = {};
    }
    if (typeof x !== 'string') {
        var err = new TypeError('Path must be a string.');
        return process.nextTick(function () {
            cb(err);
        });
    }

    opts = normalizeOptions(x, opts);

    var isFile = opts.isFile || defaultIsFile;
    var isDirectory = opts.isDirectory || defaultIsDir;
    var readFile = opts.readFile || fs.readFile;
    var realpath = opts.realpath || defaultRealpath;
    var readPackage = opts.readPackage || defaultReadPackage;
    if (opts.readFile && opts.readPackage) {
        var conflictErr = new TypeError('`readFile` and `readPackage` are mutually exclusive.');
        return process.nextTick(function () {
            cb(conflictErr);
        });
    }
    var packageIterator = opts.packageIterator;

    var extensions = opts.extensions || ['.js'];
    var includeCoreModules = opts.includeCoreModules !== false;
    var basedir = opts.basedir || path.dirname(caller());
    var parent = opts.filename || basedir;

    opts.paths = opts.paths || defaultPaths();

    // ensure that `basedir` is an absolute path at this point, resolving against the process' current working directory
    var absoluteStart = path.resolve(basedir);

    maybeRealpath(
        realpath,
        absoluteStart,
        opts,
        function (err, realStart) {
            if (err) cb(err);
            else init(realStart);
        }
    );

    var res;
    function init(basedir) {
        if ((/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/).test(x)) {
            res = path.resolve(basedir, x);
            if (x === '.' || x === '..' || x.slice(-1) === '/') res += '/';
            if ((/\/$/).test(x) && res === basedir) {
                loadAsDirectory(res, opts.package, onfile);
            } else loadAsFile(res, opts.package, onfile);
        } else if (includeCoreModules && isCore(x)) {
            return cb(null, x);
        } else loadNodeModules(x, basedir, function (err, n, pkg) {
            if (err) cb(err);
            else if (n) {
                return maybeRealpath(realpath, n, opts, function (err, realN) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realN, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function onfile(err, m, pkg) {
        if (err) cb(err);
        else if (m) cb(null, m, pkg);
        else loadAsDirectory(res, function (err, d, pkg) {
            if (err) cb(err);
            else if (d) {
                maybeRealpath(realpath, d, opts, function (err, realD) {
                    if (err) {
                        cb(err);
                    } else {
                        cb(null, realD, pkg);
                    }
                });
            } else {
                var moduleError = new Error("Cannot find module '" + x + "' from '" + parent + "'");
                moduleError.code = 'MODULE_NOT_FOUND';
                cb(moduleError);
            }
        });
    }

    function loadAsFile(x, thePackage, callback) {
        var loadAsFilePackage = thePackage;
        var cb = callback;
        if (typeof loadAsFilePackage === 'function') {
            cb = loadAsFilePackage;
            loadAsFilePackage = undefined;
        }

        var exts = [''].concat(extensions);
        load(exts, x, loadAsFilePackage);

        function load(exts, x, loadPackage) {
            if (exts.length === 0) return cb(null, undefined, loadPackage);
            var file = x + exts[0];

            var pkg = loadPackage;
            if (pkg) onpkg(null, pkg);
            else loadpkg(path.dirname(file), onpkg);

            function onpkg(err, pkg_, dir) {
                pkg = pkg_;
                if (err) return cb(err);
                if (dir && pkg && opts.pathFilter) {
                    var rfile = path.relative(dir, file);
                    var rel = rfile.slice(0, rfile.length - exts[0].length);
                    var r = opts.pathFilter(pkg, x, rel);
                    if (r) return load(
                        [''].concat(extensions.slice()),
                        path.resolve(dir, r),
                        pkg
                    );
                }
                isFile(file, onex);
            }
            function onex(err, ex) {
                if (err) return cb(err);
                if (ex) return cb(null, file, pkg);
                load(exts.slice(1), x, pkg);
            }
        }
    }

    function loadpkg(dir, cb) {
        if (dir === '' || dir === '/') return cb(null);
        if (process.platform === 'win32' && (/^\w:[/\\]*$/).test(dir)) {
            return cb(null);
        }
        if ((/[/\\]node_modules[/\\]*$/).test(dir)) return cb(null);

        maybeRealpath(realpath, dir, opts, function (unwrapErr, pkgdir) {
            if (unwrapErr) return loadpkg(path.dirname(dir), cb);
            var pkgfile = path.join(pkgdir, 'package.json');
            isFile(pkgfile, function (err, ex) {
                // on err, ex is false
                if (!ex) return loadpkg(path.dirname(dir), cb);

                readPackage(readFile, pkgfile, function (err, pkgParam) {
                    if (err) cb(err);

                    var pkg = pkgParam;

                    if (pkg && opts.packageFilter) {
                        pkg = opts.packageFilter(pkg, pkgfile);
                    }
                    cb(null, pkg, dir);
                });
            });
        });
    }

    function loadAsDirectory(x, loadAsDirectoryPackage, callback) {
        v   ∑ Í  ˇˇ !ˇÁcy&    ª ‹    !˛cS L 0@=u@J* 4C9"u%J	 ?Õ?39/˝}Ê?9˝}Ê10#"&'7326547.'732>54.'.54>32&&#"	Jâ¬y$0B)/VyJ'Q,@GI™H8eTA*LæjL{W01Og6?mP.E¥ovËX+q±YwÜ$<Q-AÇh@∑g§wE_)4/P:!	é,8¬ %3 <X8.:&6OpJ^õn<3&À-(dT-?+.Irˇˇ !˛cS&    ﬂ ü  ˇˇ Ø  y&    ª  ˇˇ Ø˛:&    ﬂ ñ    Ø  :  @H  H ?Ì2?9/3Ì2103!7!!!!## ÎH˛\)=*˛\H*˛¸xÙxÎZÕÕ˛¶Õ˝∫Fˇˇ ÇˇÁmx&    Ø@  ˇˇ ÇˇÁmx&    ≥Õ  ˇˇ ÇˇÁmx&    ∑j  ˇˇ ÇˇÁmx&    ¿k  ˇˇ ÇˇÁmâ&    ƒo  ˇˇ ÇˇÁmQ&    »g  ˇˇ ÇˇÁmê&    ÃX  ˇˇ ÇˇÁmﬂ&    –`  ˇˇ ÇˇÁmx&    ‘ø    Ç˛m: : @)0! 	J 	 ?Ì?9??Õ10".54673326766733267#".54>7Cz≠j0
üÙ§7ZChõ3¢Ù¨/<M0BÉhA" :!L$+I40A&BpíQ0[/¸‰#@0T?%W`#ZA¸¿XÇcK ,UTY/
¢+?((QLF ˇˇ ◊   x&    ØI  ˇˇ ◊   x&    ≥Ã  ˇˇ ◊   x&    ∑R  ˇˇ ◊   â&    ƒb  ˇˇ √  *x&    Ø ”  ˇˇ √  *x&    ≥g  ˇˇ √  *x&    ∑ ˜  ˇˇ √  *â&    ƒ  ˇˇ    ˛x&    ≥u  ˇˇ    ˛y&    ª  ˇˇ    ˛©&    ÿ    <˛c®: " @" /Õ???99?10#"&'732>7&'##3367®˛€.Vág C)':*
˛Ìe<-|ÙÌe<3|:˙z?y_:	√
3Q9Qÿ©¶◊˝´:˝Ø◊™É˙U   F  q:  - "@HèH,H ?Ì?Ì9/]3Ì2103!2#!#%!!3267>76&'&&##q¢règö>JlF"*GmóeOƒÖ˛Çx¢¡L*˛≥Nó^é:LpL'JQ'hK∫'ZtãN1Çêïäv($FÕÕ˛á!'vê§Tnå"  <  t:  $ @#JJ ??99//ÌÌ1032#".'#332>54&'&&##[ΩfxlSüÍò,(!;ÙÙ±>%^å\.2*P<ñC"(¢liØ~F˛Á:¸´&Da:/@
   UˇÁ· $ : "@!%*W4WW ?Ì?Ì?Ì9?10%327#"&'##".54>32373.#"3267667t*)>9RUEüLAhH&6OhÄKE|.# åä	'//M=,533f('ÈæMGUJ0X|LQ§óÑb8:>`˝]!‚-Kahe+UPE<(fB   dˇÁ„®  6 @6  W,W  ?Ì?Ì9?1032>54.#"3>32#".54673Z;:1RC4#3$!KC7c2>J*>oR0;\}°cNzU-	ŸÏ{!=I*G]gi/"=/>_D‚ND' ,WÇVJùñÑd:0Rq@7-   UˇÁí· % @ tW"tW ?˝}Ê?˝}Ê10&&#"3267#".54>32j6k+BgM5!2E(CíI+3ñUJäj@:[~ße9ï5Ò+G[`]&9M-%!–#*[êgCìçÅa9  UˇÁl® % : "@! &+W5WW	 ?Ì?Ì?Ì9?10%327#"&'##".54>3233.#"326767t+)BRUEüLAhH&5Ne{HHv+wÏã	&//M<-537l*,ÈæMGUJ0X|LQ§óÑb8;=?˚~!ﬁ-Kahe+UPNDJs  UˇÁ∆·  1 @W!W-tW! ?˝}Ê?Ì9/Ì104&#"2>7#"'3267#".54>32ÿ45(SI:jêX&ÓOö‚ì;T4N¨@+>üZkûg2 >\yñXM|W0ÿ!0 ?[;.;QÅ[05O2& –:iêWMòãwW2&Eb  ˛œ˛«¡ 0 @*W#UW
U ?Ì?Ì?Ì?Ì10!!#"&'732>7#737667>32&&#"))˛˝∑(?æs6c("F8N7$´Æ)≠'MW`1<m%&.J3L…√¸éJj'ZIΩ>^A3√yFe'-A*∏$&>'  ˇ∫˛· ) > &@t"W */W9W ?Ì?Ì9??˝}Ê10%#".54>32373#"&'732>767.#"326767r2ÑLAhH&5OhÄLE|.# À]ãø|U´K)=ãGVzU7x	'/0M=,530a';kBB0X|LQ§óÑb8:>`¸-zµw:√ )R{Q0i-Kahe+UP=6Qé  <  ® % @%
W 
 ???Ì99?106654&#"#33>32#8<I~*dÏ,Ï^AN[29eM,	wÏN138PD&1!˛®˛;9[5(!@\<%Z-˝ƒ  2  P®   µ
  ?÷Õ?1033$4¯4˛ Ï ß˛ˇ˚Y…¸7 ˛‘˛k®   ∑W  ?÷Õ?Ì103#"&'732>73ÏË* 0ìl1h$(Q>(9(4¯4…˚£Ml';;